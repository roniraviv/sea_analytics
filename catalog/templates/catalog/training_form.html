{% extends "base_generic.html" %}

{% load static %}

{% block content %}

<div class="main_container">

    <h1 id="id_training_form_header"><b>Add a new Training</b></h1>

    <br>

    {% if form.errors %}
        <p style="color: red;">
            Please correct the error{{ form.errors|pluralize }} below.
        </p>
    {% endif %}

    <form method="post"
          id="TrainingForm"
          enctype="multipart/form-data">

        {% include 'betterforms/form_as_fieldsets.html' %}

        <div id="id_training_form_trainer">
            <label for="trainer">Select Coach:</label>
            <select name="trainer">
                {% for opt in trainers %}
                <option value="{{opt}}">{{opt}}</option>
                {% endfor %}
            </select>
        </div>

	    <div id="id_training_form_uservessel_widget">
            <label for="trainees">Select Athlete:</label>
            <select multiple="multiple" id="id_training_form_trainee_sel" name="trainees[]">
                {% for opt in trainees %}
                <option value="{{opt}}">{{opt}}</option>
                {% endfor %}
            </select>
	    </div>

	    <br><br>

        <button type="submit" onclick="this.disabled=true,this.form.submit();">Save</button>
        <input type="button" id="id_training_button_delete" onclick="window.location=window.location.href.replace('update', 'delete')" value="Delete">
        <input type="button" id="id_training_button_clear" onclick="location.href='{% url 'trainings' %}'" value="Close">
    </form>

</div>

<script src="{% static 'js/jquery.multi-select.js' %}" type="text/javascript"></script>
<script>
    $(document).ready(function() {

        if (window.location.href.indexOf('/update/') != -1) {
            $('#id_training_form_header').text('Edit Training');
            $("#id_training_form_header").css('font-weight', 'bold');
        }
        else if (window.location.href.indexOf('/create/') != -1) {
            $('#id_training_form_header').text('Add a new Training');
            $("#id_training_form_header").css('font-weight', 'bold');
        }

        {% if last_trainees_sel %}
            $('#id_lut_user_vessel_id').text('{{ last_trainees_sel }}')
        {% endif %}

        $("#id_training_form_trainee_sel").multiSelect({
            selectionFooter: '&emsp;&ensp;Selected Athletes',
            afterSelect: function(trainee_name) {
                var curr_text = $('#id_lut_user_vessel_id').text();
                var vessel_num = curr_text.split(':').length;
                if (curr_text.trim()) { curr_text += ","; }
                var updated_text = curr_text + trainee_name + ":" + vessel_num;
                $('#id_lut_user_vessel_id').text(updated_text);
            },
            afterDeselect: function(trainee_name) {
                var updated_text = '';
                var curr_text_arr = $('#id_lut_user_vessel_id').text().split(',');
                var vessel_num = 1;
                for (var i=0; i<curr_text_arr.length; i++) {
                    var curr_trainee_name = curr_text_arr[i].split(':')[0];
                    if (curr_trainee_name != trainee_name) {
                        updated_text += curr_trainee_name + ":" + vessel_num + ",";
                        vessel_num += 1;
                    }
                }
                $('#id_lut_user_vessel_id').text(updated_text.slice(0,-1));
            }
        });
        $('#id_training_form_trainee_sel option').each(function () {
            var selected_trainee = $(this).prop('label')
            var curr_text_arr = $('#id_lut_user_vessel_id').text().split(',');
            for (var i=0; i<curr_text_arr.length; i++) {
                var curr_trainee_name = curr_text_arr[i].split(':')[0];
                if (selected_trainee == curr_trainee_name) {
                    $(this).prop('selected', true);
                    break;
                }
            }
        });
        $('#id_training_form_trainee_sel').multiSelect('refresh');
    });
</script>

{% endblock %}
